generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum ChannelSyncOptions {
  clientAndCompany
  // In the future we might support client only or company only
}

/// Settings model to store an Internal User's Sync settings from UI
model Setting {
  id                      String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workspaceId             String             @db.VarChar(32)
  /// Option to syncronize message and channels in both slack and copilot
  bidirectionalSlackSync  Boolean            @default(false)
  /// Option to sync only Client, Company or Both  
  channelsToSync          ChannelSyncOptions @default(clientAndCompany)
  /// Internal User id to send the message in case sender cannot be deduced
  fallbackMessageSenderId String             @db.Uuid
  /// Prefix to add to synced channels.
  /// E.g. copilot-john-doe for client channel
  slackChannelPrefix      String             @db.VarChar(255)
  /// Whether or not "Run Sync" button is clicked
  isSyncRunning           Boolean            @default(false)
  /// ID of the Internal User who clicked on Run Sync
  lastSyncedById          String?            @db.Uuid
  /// Timestamp when "Run Sync" was last clicked
  lastSyncedAt            DateTime?
  // Timestamps
  createdAt               DateTime           @default(now())
  updatedAt               DateTime?          @updatedAt

  @@unique([workspaceId], name: "UQ_Settings_workspaceId_deletedAt")
  @@index([workspaceId], name: "IX_Settings_workspaceId_deletedAt")
  @@map("Settings")
}

enum SyncStatus {
  pending
  success
  failed
}

/// Table to track which copilot channels already have a slack integration present
model SyncedChannel {
  id               String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  /// Associated Copilot workspace id
  workspaceId      String  @db.VarChar(32)
  /// Associated copilot channel ID
  copilotChannelId String? @db.VarChar(64)
  /// Associated slack channel ID
  slackChannelId   String? @db.VarChar(64)
  /// Channel name that is generated by default for slack
  slackChannelName String? @db.VarChar(255)

  /// Current status of sync
  status SyncStatus

  /// Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@unique([slackChannelId], name: "UQ_SyncedChannels_slackChannelId")
  @@unique([slackChannelName], name: "UQ_SyncedChannels_slackChannelName")
  @@unique([copilotChannelId, deletedAt], name: "UQ_SyncedChannels_copilotChannelId_deletedAt")
  @@index([slackChannelId], name: "IX_SyncedChannels_slackChannelId")
  @@index([copilotChannelId, status, deletedAt], name: "IX_SyncedChannels_copilotChannelId_status_deletedAt")
  @@map("SyncedChannels")
}

model SyncedMessage {
  id               String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  /// Associated Copilot workspace id
  workspaceId      String  @db.VarChar(32)
  /// Associated copilot channel ID
  copilotChannelId String? @db.VarChar(64)
  /// Associated slack channel ID
  slackChannelId   String? @db.VarChar(64)
  /// Message id as stored in Copilot
  messageId        String  @db.VarChar(255)
  /// Sender ID to track issues in prod
  senderId         String  @db.Uuid

  /// Current status of sync
  status SyncStatus

  /// Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([messageId], name: "UQ_SyncedMessages_messageId")
  @@index([messageId], name: "IX_SyncedMessages_messageId")
  @@map("SyncedMessages")
}

model SyncedSlackMessage {
  id        String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  eventTime String

  /// Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("SyncedSlackMessages")
}

model SyncedWorkspaces {
  id          String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workspaceId String @db.VarChar(32)

  /// Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
